#cloud-config
package_update: true
package_upgrade: true

packages:
  - redis-server

write_files:
  - path: /etc/redis/redis.conf
    content: |
      # Network
      bind 0.0.0.0
      port 6379
      protected-mode yes
      requirepass ${redis_password}

      # Memory
      maxmemory ${maxmemory_mb}mb
      maxmemory-policy ${maxmemory_policy}

      # Persistence (optional, disabled for cache-only use)
      save ""
      appendonly no

      # Logging
      loglevel notice
      logfile /var/log/redis/redis-server.log

      # Performance tuning
      tcp-backlog 511
      timeout 0
      tcp-keepalive 300

      # Security
      rename-command FLUSHDB ""
      rename-command FLUSHALL ""
      rename-command DEBUG ""
    permissions: '0640'
    owner: redis:redis

runcmd:
  - systemctl enable redis-server
  - systemctl restart redis-server

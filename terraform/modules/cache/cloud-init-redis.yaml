#cloud-config
package_update: true
package_upgrade: true

packages:
  - redis-server
  - unattended-upgrades

write_files:
  - path: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";

  - path: /etc/redis/redis.conf
    content: |
      # Network
      bind 127.0.0.1 __PRIVATE_IP__
      port 6379
      protected-mode yes
      requirepass ${redis_password}

      # Memory
      maxmemory ${maxmemory_mb}mb
      maxmemory-policy ${maxmemory_policy}

      # Persistence
      save 900 1
      save 300 10
      save 60 10000
      appendonly yes
      appendfsync everysec

      # Logging
      loglevel notice
      logfile /var/log/redis/redis-server.log

      # Performance tuning
      tcp-backlog 511
      timeout 0
      tcp-keepalive 300

      # Security
      rename-command FLUSHDB ""
      rename-command FLUSHALL ""
      rename-command DEBUG ""
    permissions: '0640'
    owner: redis:redis

runcmd:
  - bash -c "PRIVATE_IP=$(hostname -I | awk '{print $1}'); sed -i \"s/__PRIVATE_IP__/$PRIVATE_IP/\" /etc/redis/redis.conf"
  - dpkg-reconfigure -f noninteractive unattended-upgrades
  - systemctl enable unattended-upgrades
  - systemctl enable redis-server
  - systemctl restart redis-server
